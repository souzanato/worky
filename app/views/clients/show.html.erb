<% breadcrumb :client, @client %>

<div class="mb-3 d-md-flex fw-bold">
  <div class="mt-2 mt-md-0">
    <%= link_to clients_path, class: "text-decoration-none text-dark" do %>
      <i class="fa fa-arrow-left fa-fw me-1 text-dark text-opacity-50"></i>
      <%= t(".back", default: "Back") %>
    <% end %>
  </div>
  <% if can?(:update, @client) %>
    <div class="ms-md-4 mt-2 mt-md-0">
      <%= link_to edit_client_path(@client), class: "text-decoration-none text-dark" do %>
        <i class="fa fa-pen fa-fw me-1 text-dark text-opacity-50"></i>
        <%= t(".edit", default: "Edit") %>
      <% end %>
    </div>
  <% end %>
  <% if can?(:destroy, @client) %>
    <div class="ms-md-4 mt-2 mt-md-0">
      <%= link_to client_path(@client),
                  data: { turbo_method: :delete, turbo_confirm: t(".confirm_delete", default: "Are you sure?") },
                  class: "text-decoration-none text-danger" do %>
        <i class="fa fa-trash fa-fw me-1 text-danger text-opacity-75"></i>
        <%= t(".delete", default: "Delete") %>
      <% end %>
    </div>
  <% end %>
</div>

<!-- Abas -->
<ul class="nav nav-tabs nav-tabs-inverse" role="tablist">
  <li class="nav-item" role="presentation">
    <a href="#general-tab" data-bs-toggle="tab" class="nav-link active" aria-selected="true" role="tab">
      <i class="fa fa-fw fa-lg fa-building"></i>
      <span class="d-none d-xl-inline">General</span>
    </a>
  </li>
  <li class="nav-item" role="presentation">
    <a href="#executions-tab" data-bs-toggle="tab" class="nav-link" aria-selected="false" role="tab">
      <i class="fa fa-fw fa-lg fa-diagram-project"></i>
      <span class="d-none d-xl-inline">Executions</span>
    </a>
  </li>
</ul>

<!-- Conteúdo das abas -->
<div class="tab-content p-3 border border-top-0 bg-white">
  <!-- General -->
  <div class="tab-pane fade show active" id="general-tab" role="tabpanel">
    <div class="fs-5 mb-3">
      <%= @client.name.presence || "—" %><br/>
      <div class="small text-dark text-opacity-75 mb-2">
        <%= mail_to(@client.email, class: 'text-decoration-none' ) %>
      </div>
    </div>
    <div class="text-dark text-opacity-75"><%= simple_format(@client.description) %></div>
  </div>


  <!-- Executions -->
  <div class="tab-pane fade" id="executions-tab" role="tabpanel">

    <!-- Card última execução -->
    <% last_execution = @client.workflow_executions.order(created_at: :desc).first %>

    <% if last_execution %>
      <div class="card mb-3">
        <div class="card-header d-flex align-items-center">
          <i class="fa fa-diagram-project me-2 text-gray text-opacity-50"></i>
          Last Execution
          <span class="badge ms-2 <%= last_execution.status == "completed" ? "bg-success" : "bg-secondary" %>">
            <%= last_execution.status %>
          </span>
          <span class="ms-auto small text-muted">
            Started <%= l last_execution.started_at, format: :short %>
          </span>
        </div>
        <div class="card-body">
          <p><strong>Workflow:</strong> <%= last_execution.workflow.title %></p>
          <p><strong>Progress:</strong> <%= last_execution.progress %>%</p>

          <%= link_to "View Execution", client_workflow_execution_path(@client, last_execution),
                      class: "btn btn-sm btn-outline-primary" %>
        </div>
      </div>
    <% else %>
      <div class="text-muted mb-3">No executions found for this client.</div>
    <% end %>

    <!-- Botões de ação -->
    <div class="mb-3">
      <%= link_to "New Execution", new_client_workflow_execution_path(@client),
            class: "btn btn-theme me-2" %>
      <button class="btn btn-outline-secondary" type="button" data-bs-toggle="collapse"
              data-bs-target="#previousExecutions" aria-expanded="false" aria-controls="previousExecutions">
        Previous Executions
      </button>
    </div>

    <!-- Acordeon execuções anteriores -->
    <div class="collapse" id="previousExecutions">
      <div class="card">
        <div class="card-body p-0">
          <table class="table table-sm table-hover align-middle mb-0">
            <thead>
              <tr>
                <th>ID</th>
                <th>Workflow</th>
                <th>Status</th>
                <th>Started</th>
                <th>Finished</th>
              </tr>
            </thead>
            <tbody>
              <% @client.workflow_executions.order(created_at: :desc).offset(1).each do |exec| %>
                <tr>
                  <td><%= link_to exec.id, client_workflow_execution_path(@client, exec) %></td>
                  <td><%= exec.workflow.title %></td>
                  <td>
                    <span class="badge <%= exec.status == "completed" ? "bg-success" : "bg-secondary" %>">
                      <%= exec.status %>
                    </span>
                  </td>
                  <td><%= l exec.started_at, format: :short %></td>
                  <td><%= exec.finished_at ? l(exec.finished_at, format: :short) : "—" %></td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>




</div>
