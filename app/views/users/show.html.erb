<%# app/views/users/show.html.erb %>

<% breadcrumb :user, @user %>

<div class="mb-3 d-md-flex fw-bold">
  <div class="mt-2 mt-md-0">
    <%= link_to users_path, class: "text-decoration-none text-dark" do %>
      <i class="fa fa-arrow-left fa-fw me-1 text-dark text-opacity-50"></i> <%= t(".back", default: "Back") %>
    <% end %>
  </div>
  <% if can?(:update, @user) %>
    <div class="ms-md-4 mt-2 mt-md-0">
      <%= link_to edit_user_path(@user), class: "text-decoration-none text-dark" do %>
        <i class="fa fa-pen fa-fw me-1 text-dark text-opacity-50"></i> <%= t(".edit", default: "Edit") %>
      <% end %>
    </div>
  <% end %>
  <% if can?(:destroy, @user) %>
    <div class="ms-md-4 mt-2 mt-md-0">
      <%= link_to user_path(@user),
                  data: { turbo_method: :delete, turbo_confirm: t(".confirm_delete", default: "Are you sure?") },
                  class: "text-decoration-none text-danger" do %>
        <i class="fa fa-trash fa-fw me-1 text-danger text-opacity-75"></i> <%= t(".delete", default: "Delete") %>
      <% end %>
    </div>
  <% end %>
</div>

<div class="row gx-4">
  <!-- COLUNA PRINCIPAL -->
  <div class="col-xl-8 mb-xl-0 mb-4">
    <!-- Profile / Identificação -->
    <div class="card border-0 mb-4">
      <div class="card-header bg-none p-3 h6 m-0 d-flex align-items-center">
        <i class="fa fa-user fa-lg me-2 text-gray text-opacity-50"></i>
        <%= t(".profile", default: "Profile") %>
        <% if can?(:update, @user) %>
          <%= link_to edit_user_path(@user), class: "ms-auto text-decoration-none text-gray-500" do %>
            <i class="fa fa-pen fa-lg me-1"></i> <%= t(".edit", default: "Edit") %>
          <% end %>
        <% end %>
      </div>
      <div class="card-body p-3 text-dark fw-bold">
        <div class="row align-items-center">
          <div class="col-lg-2 d-flex align-items-center justify-content-center">
            <span class="rounded-circle overflow-hidden" style="width:72px; height:72px; background:#f3f3f3">
              <%= image_tag "color-admin/img/user/#{@user.avatar}", alt: "", class: "img-fluid" %>
            </span>
          </div>
          <div class="col-lg-10 mt-3 mt-lg-0">
            <div class="fs-5">
              <%= [@user.first_name, @user.last_name].compact.join(" ").presence || "—" %>
            </div>
            <div class="small text-dark text-opacity-75">
              <%= mail_to @user.email, @user.email, class: "text-decoration-none" %>
            </div>
            <div class="mt-2">
              <%# Exibe role atual "bonita" se houver %>
              <% role_name = User.role(@user.current_role_code)&.name || @user.current_role_code&.to_s %>
              <% if role_name.present? %>
                <span class="badge bg-theme"><%= role_name %></span>
              <% else %>
                <span class="badge bg-secondary"><%= t(".no_role", default: "No role") %></span>
              <% end %>
            </div>
          </div>
        </div>
        <hr class="my-4" />
        <div class="row g-3">
          <div class="col-md-6">
            <div class="text-dark text-opacity-50 small"><%= t(".created_at", default: "Created at") %></div>
            <div><%= l @user.created_at, format: :short %></div>
          </div>
          <div class="col-md-6">
            <div class="text-dark text-opacity-50 small"><%= t(".updated_at", default: "Updated at") %></div>
            <div><%= l @user.updated_at, format: :short %></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Acesso / Login stats -->
    <div class="card border-0">
      <div class="card-header bg-none p-3 h6 m-0 d-flex align-items-center">
        <i class="fa fa-shield-halved fa-lg me-2 text-gray text-opacity-50"></i>
        <%= t(".security_and_signins", default: "Security & Sign-ins") %>
      </div>
      <div class="card-body">
        <table class="table table-borderless table-sm fw-bold m-0">
          <tbody>
            <tr>
              <td class="w-200px"><%= t(".sign_in_count", default: "Sign ins") %></td>
              <td class="text-end"><%= @user.sign_in_count || 0 %></td>
            </tr>
            <tr>
              <td><%= t(".current_sign_in_at", default: "Current sign in at") %></td>
              <td class="text-end"><%= @user.current_sign_in_at ? l(@user.current_sign_in_at, format: :short) : "—" %></td>
            </tr>
            <tr>
              <td><%= t(".last_sign_in_at", default: "Last sign in at") %></td>
              <td class="text-end"><%= @user.last_sign_in_at ? l(@user.last_sign_in_at, format: :short) : "—" %></td>
            </tr>
            <tr>
              <td><%= t(".current_sign_in_ip", default: "Current sign in IP") %></td>
              <td class="text-end"><%= @user.current_sign_in_ip.presence || "—" %></td>
            </tr>
            <tr>
              <td><%= t(".last_sign_in_ip", default: "Last sign in IP") %></td>
              <td class="text-end"><%= @user.last_sign_in_ip.presence || "—" %></td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- SIDEBAR DIREITA -->
  <div class="col-xl-4">
    <!-- Status -->
    <div class="card border-0 mb-4">
      <div class="card-header bg-none p-3 h6 m-0 d-flex align-items-center">
        <%= t(".status", default: "Status") %>
      </div>
      <div class="card-body fw-bold">
        <div class="mb-2">
          <div class="text-dark text-opacity-50 small"><%= t(".confirmation", default: "Confirmation") %></div>
          <% if @user.respond_to?(:confirmed?) && @user.confirmed? %>
            <span class="badge bg-success"><i class="fa fa-check me-1"></i><%= t(".confirmed", default: "Confirmed") %></span>
            <div class="small text-dark text-opacity-50 mt-1">
              <%= t(".confirmed_at", default: "Confirmed at") %>:
              <%= l(@user.confirmed_at, format: :short) rescue "—" %>
            </div>
          <% else %>
            <span class="badge bg-secondary"><i class="fa fa-clock me-1"></i><%= t(".unconfirmed", default: "Unconfirmed") %></span>
          <% end %>
        </div>

        <% if @user.respond_to?(:locked_at) %>
          <div class="mt-3">
            <div class="text-dark text-opacity-50 small"><%= t(".lock", default: "Lock") %></div>
            <% if @user.locked_at.present? %>
              <span class="badge bg-danger"><i class="fa fa-lock me-1"></i><%= t(".locked", default: "Locked") %></span>
              <div class="small text-dark text-opacity-50 mt-1">
                <%= l @user.locked_at, format: :short %>
              </div>
            <% else %>
              <span class="badge bg-success"><i class="fa fa-unlock me-1"></i><%= t(".unlocked", default: "Unlocked") %></span>
            <% end %>
          </div>
        <% end %>
      </div>
    </div>

    <!-- Roles (Rolify) -->
    <% if @user.respond_to?(:roles) %>
      <div class="card border-0 mb-4">
        <div class="card-header bg-none p-3 h6 m-0 d-flex align-items-center">
          <%= t(".assigned_roles", default: "Assigned roles") %>
          <% if can?(:update, @user) %>
            <%= link_to edit_user_path(@user), class: "ms-auto text-decoration-none text-gray-500" do %>
              <i class="fa fa-pen me-1"></i> <%= t(".manage", default: "Manage") %>
            <% end %>
          <% end %>
        </div>
        <div class="card-body fw-bold">
          <% if @user.roles.any? %>
            <div class="d-flex flex-wrap gap-1">
              <% @user.roles.each do |r| %>
                <span class="badge bg-dark"><%= r.name %></span>
              <% end %>
            </div>
          <% else %>
            <span class="text-muted">—</span>
          <% end %>
        </div>
      </div>
    <% end %>

    <!-- Metadados -->
    <div class="card border-0 mb-4">
      <div class="card-header bg-none p-3 h6 m-0 d-flex align-items-center">
        <%= t(".metadata", default: "Metadata") %>
      </div>
      <div class="card-body fw-bold">
        <div class="small text-dark text-opacity-50"><%= t(".user_id", default: "User ID") %></div>
        <div class="mb-3"><%= @user.id %></div>

        <% if @user.respond_to?(:reset_password_sent_at) %>
          <div class="small text-dark text-opacity-50"><%= t(".reset_sent_at", default: "Reset sent at") %></div>
          <div class="mb-3"><%= @user.reset_password_sent_at ? l(@user.reset_password_sent_at, format: :short) : "—" %></div>
        <% end %>
      </div>
    </div>
  </div>
</div>
